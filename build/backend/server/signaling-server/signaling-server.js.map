{"version":3,"sources":["../../../../src/backend/server/signaling-server/signaling-server.js"],"names":["async","require","util","EventEmitter","userModule","roomModule","errors","logger","BROADCASTMESSAGE","ENTER_ROOM","LEAVE_ROOM","NEGOTIATION_MESSAGE","OFFER","ANSWER","CANDIDATE","SUCESS_NEGOTIATION","FAILED_NEGOTIATION","ROOM_MESSANGE","FAILED_ENTER_ROOM","SESSION_MESSAGE","LOGIN","LOGOUT","ERR_MESSAGE","INVALIDMESSAGE","INVALIDUSER","SERVER_ERR","SignalingServer","wss","callback","_start","info","Error","self","on","connection","emit","message","parsedMessage","waterfall","asyncCallBack","parsingMessage","mParsedMessage","isInvalidMessage","whatType","type","handleSessionMessage","handleMessage","e","sendErrMessage","closeConnection","data","JSON","parse","error","InvalidMessageError","createUser","fromUserID","err","success","send","stringify","deleteUser","roomID","toUserID","sdp","candidate","isRoom","enterRoom","enteredRoom","createRoom","createdRoom","toString","sendTo","broadcastMessage","from","userID","broadcast","leaveRoom","rooms","findUserFromConnection","isUser","closeConnectionWithUserID","isInRoom","mType","splitVar","split"],"mappings":"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","sourcesContent":["var async = require('async');\r\nvar util = require('util');\r\nvar EventEmitter = require('events').EventEmitter;\r\nvar userModule= require('./user.js');\r\nvar roomModule= require('./room.js');\r\nvar errors = require('./errors')\r\nvar logger =require('../../logger').logger\r\n\r\nconst BROADCASTMESSAGE ={\r\n  ENTER_ROOM:\"broadcast:enterRoom\",\r\n  LEAVE_ROOM:\"broadcast:leaveRoom\"\r\n}\r\n\r\nconst NEGOTIATION_MESSAGE ={\r\n  OFFER:\"negotiation:offer\",\r\n  ANSWER:\"negotiation:answer\",\r\n  CANDIDATE:\"negotiation:candidate\",\r\n  SUCESS_NEGOTIATION:\"negotiation:sucess\",\r\n  FAILED_NEGOTIATION:\"negotiation:failed\"\r\n}\r\n\r\nconst ROOM_MESSANGE ={\r\n  ENTER_ROOM:\"room:enterRoom\",\r\n  FAILED_ENTER_ROOM:\"room:failedEnterRoom\",\r\n  LEAVE_ROOM:\"room:leaveRoom\",\r\n}\r\n\r\nconst SESSION_MESSAGE ={\r\n  LOGIN: \"session:login\",\r\n  LOGOUT: \"session:logout\"\r\n}\r\n\r\nconst ERR_MESSAGE ={\r\n  INVALIDMESSAGE: \"err:invalidMessage\",\r\n  INVALIDUSER: \"err:invalidUser\",\r\n  SERVER_ERR:\"err:serverError\"\r\n}\r\n\r\nclass SignalingServer extends EventEmitter{\r\n  \r\n  constructor(){\r\n    super()\r\n  }\r\n\r\n  init(wss,callback){\r\n\r\n    if(wss){\r\n\r\n        this.wss = wss\r\n\r\n        this._start()\r\n\r\n        logger.info(\"signaling server successfully inited\")\r\n\r\n        callback(null)\r\n\r\n    }else{\r\n        callback(new Error(\"wss cant not be null\"))\r\n    }\r\n  }\r\n\r\n  _start(){\r\n\r\n      var self = this\r\n\r\n      self.wss.on('connection', function(connection) {\r\n          \r\n          logger.info(\"[SignalServer] user connected\" );\r\n\r\n          self.emit('connection',connection)\r\n      \r\n          connection.on('message', function(message) { \r\n        \r\n            logger.info(\"got message\",message )  \r\n\r\n            var parsedMessage\r\n\r\n            async.waterfall([\r\n              function(asyncCallBack){\r\n                self.parsingMessage(message,asyncCallBack);\r\n                  \r\n              },\r\n              function(mParsedMessage,asyncCallBack){\r\n        \r\n                parsedMessage = mParsedMessage;\r\n        \r\n                logger.info(\"parsedMessage :\",parsedMessage)\r\n        \r\n                self.isInvalidMessage(parsedMessage,asyncCallBack)\r\n        \r\n              },\r\n              function(asyncCallBack){\r\n        \r\n                if(self.whatType(parsedMessage.type) ===\"session\"){\r\n          \r\n                  self.handleSessionMessage(parsedMessage,connection,asyncCallBack)\r\n        \r\n                }else{\r\n          \r\n                  self.handleMessage(parsedMessage,asyncCallBack)\r\n                }\r\n          \r\n              }\r\n          \r\n              ],function(e){\r\n                if(e){\r\n\r\n                  e.sendErrMessage(connection)\r\n\r\n                }\r\n                \r\n              })\r\n            }); \r\n            \r\n          connection.on(\"close\", function() { \r\n            if(connection!=null){\r\n              self.closeConnection(connection)\r\n            }\r\n          })    \r\n      })\r\n  }\r\n\r\n  parsingMessage(message,callback){\r\n\r\n    var data; \r\n    \r\n    try { \r\n        data = JSON.parse(message); \r\n\r\n    } catch (e) { \r\n        logger.error(\"Invalid JSON e:\",e); \r\n        \r\n        return callback(new errors.InvalidMessageError(\"Invalid JSON\"))\r\n    }\r\n\r\n    return callback(null,data)\r\n  }\r\n\r\n  handleSessionMessage(parsedMessage,connection,callback){\r\n    \r\n    var self = this\r\n\r\n    var data = parsedMessage\r\n    \r\n    switch (data.type) {\r\n      case SESSION_MESSAGE.LOGIN:\r\n\r\n        \r\n        userModule.createUser(data.fromUserID,connection,(err,success)=>{\r\n\r\n          if(err){\r\n\r\n            return err.sendErrMessage(connection)\r\n          }\r\n\r\n          var message = {\r\n            type: SESSION_MESSAGE.LOGIN,\r\n            success: success\r\n          }\r\n\r\n          logger.info(\"successfully login \",data.fromUserID)\r\n\r\n          connection.send(JSON.stringify(message));\r\n\r\n          self.emit()\r\n        });\r\n\r\n      break;\r\n      case SESSION_MESSAGE.LOGOUT:\r\n              \r\n        logger.info(data.fromUserID ,\" logout\");\r\n        \r\n        userModule.deleteUser(data.fromUserID)\r\n\r\n        message ={\r\n        \r\n          type: SESSION_MESSAGE.LOGOUT,\r\n          fromUserID: data.fromUserID,\r\n          success: true\r\n        };\r\n\r\n        connection.send(JSON.stringify(message));\r\n        \r\n        self(emit)\r\n\r\n      break;\r\n    }\r\n\r\n    callback(null)\r\n    \r\n  }\r\n\r\n  isInvalidMessage(parsedMessage,callback){\r\n    \r\n    var data = parsedMessage\r\n\r\n    if(!data.type){\r\n      \r\n      return callback(new errors.InvalidMessageError(\"type undefiend\"))\r\n    } \r\n\r\n    switch (data.type) {\r\n\r\n      case SESSION_MESSAGE.LOGIN:\r\n        if(!data.fromUserID){\r\n\r\n          return callback(new errors.InvalidMessageError(\"fromUserID undefiend\"))\r\n\r\n        }\r\n\r\n      break\r\n\r\n      case SESSION_MESSAGE.LOGOUT:\r\n        if(!data.fromUserID){\r\n\r\n          return callback(new errors.InvalidMessageError(\"fromUserID undefiend\"))\r\n\r\n        }\r\n\r\n      break\r\n\r\n      case ROOM_MESSANGE.ENTER_ROOM:\r\n        if(!data.fromUserID || !data.roomID){\r\n\r\n          return callback(new errors.InvalidMessageError(\"fromUserID or roomID undefiend\"))\r\n\r\n        }\r\n\r\n      break\r\n\r\n      case ROOM_MESSANGE.LEAVE_ROOM:\r\n\r\n        if(!data.fromUserID || !data.roomID){\r\n\r\n          return callback(new errors.InvalidMessageError(\"fromUserID or roomID undefiend\"))\r\n\r\n        }\r\n\r\n      break\r\n\r\n      case NEGOTIATION_MESSAGE.OFFER:\r\n\r\n        if(!data.fromUserID || !data.toUserID || !data.sdp){\r\n\r\n          return callback(new errors.InvalidMessageError(\"fromUserID or toUserID or offer undefiend\"))\r\n\r\n        }\r\n\r\n      break\r\n\r\n      case NEGOTIATION_MESSAGE.ANSWER:\r\n\r\n        if(!data.fromUserID || !data.toUserID|| !data.sdp){\r\n\r\n          return callback(new errors.InvalidMessageError(\"fromUserID or toUserID or answer undefiend\"))\r\n\r\n        }\r\n\r\n      break;\r\n\r\n      case NEGOTIATION_MESSAGE.CANDIDATE:\r\n\r\n      if(!data.fromUserID || !data.candidate || !data.toUserID){\r\n\r\n        return callback(new errors.InvalidMessageError(\"fromUserID or toUserID or candidate undefiend\"))\r\n\r\n      }\r\n\r\n      break;\r\n\r\n      default:\r\n\r\n        return callback(new errors.InvalidMessageError(\"invalid Type type: \" +data.type))\r\n\r\n      break;\r\n\r\n    }\r\n      \r\n    return callback(null)\r\n    \r\n  }\r\n\r\n  handleMessage(parsedMessage,callback){\r\n\r\n    var self =this\r\n\r\n    var data = parsedMessage;\r\n\r\n    switch (data.type) {\r\n      \r\n      case ROOM_MESSANGE.ENTER_ROOM: \r\n          \r\n        logger.info(\"enter room\",data.fromUserID ,data.roomID)\r\n\r\n        async.waterfall([\r\n          function(asyncCallBack){\r\n            roomModule.isRoom(data.roomID,asyncCallBack)\r\n\r\n          },\r\n          function(isRoom,asyncCallBack){\r\n              if(isRoom){\r\n                logger.info(\"enterRoom\")\r\n\r\n                roomModule.enterRoom(data.roomID,data.fromUserID,(err,enteredRoom)=>{\r\n                  if(err){\r\n\r\n                    asyncCallBack(err);\r\n\r\n                  }else{\r\n                    self.emit('enterRoom',data.roomID,enteredRoom,data.fromUserID);  \r\n                    asyncCallBack(null);\r\n\r\n                  }\r\n      \r\n                });\r\n\r\n              }else{\r\n\r\n                \r\n                logger.info(\"createRoom(\"+ data.roomID+\")\")\r\n\r\n                roomModule.createRoom(data.roomID,data.fromUserID,(err,createdRoom)=>{\r\n                  \r\n                  if(err){\r\n                    asyncCallBack(err)\r\n                  }else{\r\n                    self.emit('createRoom',data.roomID,createdRoom,data.fromUserID);\r\n                    asyncCallBack(null)\r\n                  }\r\n\r\n                })\r\n              }\r\n\r\n          }],function(err){\r\n            if(err){\r\n\r\n              logger.error(err.toString())\r\n\r\n              callback(err)\r\n              \r\n            }else{\r\n\r\n              var message ={\r\n\r\n                // from:data.fromUserID,\r\n                type: ROOM_MESSANGE.ENTER_ROOM,\r\n                success: true\r\n              }\r\n\r\n              userModule.sendTo(data.fromUserID,message);\r\n\r\n              var broadcastMessage ={\r\n\r\n                from:data.fromUserID,\r\n                type: BROADCASTMESSAGE.ENTER_ROOM,\r\n                userID: data.fromUserID,\r\n              }\r\n\r\n              roomModule.broadcast(data.fromUserID,data.roomID,broadcastMessage,(err)=>{\r\n                \r\n                if(err){\r\n                  //TODO: errHandle\r\n                }\r\n\r\n              })\r\n\r\n              \r\n              callback(null)\r\n              \r\n            }\r\n          }\r\n        )\r\n        \r\n            \r\n      break;\r\n      case ROOM_MESSANGE.LEAVE_ROOM: \r\n      \r\n        logger.info(data.fromUserID ,\" leave from\",data.roomID);\r\n        \r\n        roomModule.leaveRoom(data.fromUserID,data.roomID,(err)=>{\r\n\r\n          if(err){\r\n            //can not be err\r\n          }\r\n\r\n          self.emit('leaveRoom',data.roomID,roomModule.rooms[data.roomID]);\r\n\r\n          var message={\r\n\r\n            fromUserID: data.fromUserID,\r\n            type: ROOM_MESSANGE.LEAVE_ROOM,\r\n\r\n          }\r\n\r\n          userModule.sendTo(data.fromUserID,message);\r\n\r\n          var broadcastMessage={\r\n            userID: data.fromUserID,\r\n            type: BROADCASTMESSAGE.LEAVE_ROOM\r\n          }\r\n\r\n          if(roomModule.rooms[data.roomID]){\r\n\r\n            roomModule.broadcast(data.fromUserID,data.roomID,broadcastMessage,(err)=>{\r\n              if(err){\r\n                \r\n                callback(err)\r\n              }\r\n              \r\n            });\r\n\r\n          }\r\n          \r\n          callback(null)\r\n\r\n        });\r\n      \r\n      break;\r\n\r\n      case NEGOTIATION_MESSAGE.OFFER:\r\n    \r\n        logger.info(\"Sending offer from \", data.fromUserID,\"to \",data.toUserID);\r\n      \r\n        userModule.sendTo(data.toUserID, { \r\n          fromUserID: data.fromUserID,\r\n          type: NEGOTIATION_MESSAGE.OFFER, \r\n          sdp: data.sdp, \r\n          toUserID: data.toUserID\r\n        }); \r\n\r\n        // self.emit();  \r\n        callback(null)\r\n\r\n      break;\r\n\r\n      case NEGOTIATION_MESSAGE.ANSWER: \r\n\r\n        logger.info(\"Sending answer from \",data.fromUserID ,\" to \",data.toUserID); \r\n\r\n        userModule.sendTo(data.toUserID, { \r\n          fromUserID: data.fromUserID,\r\n          type: NEGOTIATION_MESSAGE.ANSWER, \r\n          sdp: data.sdp, \r\n          toUserID: data.toUserID\r\n        }); \r\n\r\n        // self.emit();\r\n        callback(null)\r\n\r\n      break; \r\n      \r\n      case NEGOTIATION_MESSAGE.CANDIDATE: \r\n        \r\n        logger.info(\"Sending candidate from\",data.fromUserID,\" to \", data.toUserID); \r\n\r\n        userModule.sendTo(data.toUserID, { \r\n          fromUserID: data.fromUserID,\r\n          type: NEGOTIATION_MESSAGE.CANDIDATE, \r\n          candidate: data.candidate, \r\n          toUserID: data.toUserID\r\n        }); \r\n\r\n        // self.emit();\r\n        callback(null)\r\n        \r\n      break;\r\n\r\n      default: \r\n\r\n        logger.error(\"send Invalide Message err to \",data.fromUserID )\r\n        userModule.sendTo(data.fromUserID, { \r\n            type: ERR_MESSAGE.INVALIDMESSAGE, \r\n            message: \"sending Invalid Message type:\" + data.type \r\n          }); \r\n        callback(null)\r\n      \r\n      break; \r\n    }\r\n\r\n\r\n  }\r\n\r\n\r\n  closeConnection(connection){\r\n\r\n    logger.info(\"ws client connection close\")\r\n\r\n    var self = this;\r\n    \r\n    userModule.findUserFromConnection(connection,(err,isUser,userID)=>{\r\n      \r\n      if(err){\r\n        logger.error(err)  //err shuld not be happen\r\n      }\r\n\r\n      if(isUser){\r\n\r\n        self.closeConnectionWithUserID(userID)\r\n\r\n      }\r\n    })\r\n\r\n    \r\n  }\r\n\r\n  closeConnectionWithUserID(userID){\r\n\r\n    logger.info('ws client connection close userID:' + userID)\r\n\r\n    var self = this\r\n    \r\n    userModule.isInRoom(userID,(err,isRoom,roomID)=>{\r\n\r\n      if(err){\r\n        logger.error(err)\r\n        throw err\r\n      }\r\n\r\n      if(isRoom){\r\n\r\n        logger.info(userID ,\"leaveRoom from \" ,roomID)\r\n\r\n        roomModule.leaveRoom(userID,roomID,(err)=>{\r\n          \r\n          if(err){\r\n            logger.error(err)             // this err never happen. if this happen, server have to die\r\n            throw err\r\n          }else{\r\n\r\n            self.emit(\"leaveRoom\",roomID,roomModule.rooms[roomID],userID)\r\n\r\n            if(roomModule.rooms[roomID]){\r\n\r\n              var broadcastMessage={\r\n                userID: userID,\r\n                type: BROADCASTMESSAGE.LEAVE_ROOM\r\n              }\r\n\r\n              roomModule.broadcast(userID,roomID,broadcastMessage,(err)=>{\r\n                if(err){\r\n                  logger.error(err);\r\n                  throw err\r\n                }\r\n              \r\n              });\r\n\r\n            }\r\n          }\r\n        })\r\n      }\r\n    });\r\n\r\n    userModule.deleteUser(userID)\r\n\r\n  }\r\n\r\n  whatType(type){\r\n\r\n    var mType \r\n\r\n    var splitVar =type.split(\":\")\r\n    \r\n    mType =splitVar[0]\r\n\r\n    return mType\r\n    \r\n  }\r\n}\r\n\r\nexport {SignalingServer}"],"file":"signaling-server.js"}
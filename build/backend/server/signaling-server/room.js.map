{"version":3,"sources":["../../../../src/backend/server/signaling-server/room.js"],"names":["ROOM_AVAILABLE_USER_NUM","require","MAX_ROOM_NAME_LENGTH","MIN_ROOM_NAME_LENGTH","errors","rooms","module","exports","user","forbiddenNames","isNameForbidden","roomName","indexOf","roomIDs","isNameTooLong","roomID","length","isNameTooShort","isUserinRoom","userID","users","isRoom","callback","InvalidMessageError","createRoom","status","USER_STATUS","INROOM","InvalidUserError","room","deleteRoom","enterRoom","leaveRoom","ONLINE","Object","keys","err","checkfull","broadcast","from_userID","message","sendTo"],"mappings":";AACA,IAAIA,uBAAuB,GAAGC,OAAO,CAAC,aAAD,CAAP,CAAuBD,uBAArD;AACA,IAAIE,oBAAoB,GAAED,OAAO,CAAC,aAAD,CAAP,CAAuBC,oBAAjD;AACA,IAAIC,oBAAoB,GAAGF,OAAO,CAAC,aAAD,CAAP,CAAuBE,oBAAlD;AACA,IAAIC,MAAM,GAAGH,OAAO,CAAC,UAAD,CAApB;AACA,IAAII,KAAK,GAAE,EAAX;;AAEAC,MAAM,CAACC,OAAP,CAAeF,KAAf,GAAuBA,KAAvB;;AAEA,IAAIG,IAAI,GAAEP,OAAO,CAAC,WAAD,CAAjB;;AAEA,IAAIQ,cAAc,GAAG,EAArB;;;;AAIA;AACA;AACA;AACA;AACA,SAASC,eAAT,CAAyBC,QAAzB,EAAkC;;AAE9B,SAAOF,cAAc,CAACG,OAAf,CAAuBC,OAAvB,KAAkC,CAAzC;AACH;;AAED,SAASC,aAAT,CAAuBC,MAAvB,EAA8B;;AAE1B,SAAOA,MAAM,CAACC,MAAP,GAAgBd,oBAAvB;AACH;;AAED,SAASe,cAAT,CAAwBF,MAAxB,EAA+B;;AAE3B,SAAOA,MAAM,CAACC,MAAP,GAAgBb,oBAAvB;AACH;;AAED,SAASe,YAAT,CAAsBC,MAAtB,EAA6BJ,MAA7B,EAAoC;;AAEhC,MAAIV,KAAK,CAACU,MAAD,CAAL,CAAcK,KAAd,CAAoBD,MAApB,CAAJ,EAAgC;;AAE5B,WAAO,IAAP;AACH,GAHD,MAGK;AACD,WAAO,KAAP;AACH;;AAEJ;;;;AAID;AACA;AACA;AACA;AACA;AACAb,MAAM,CAACC,OAAP,CAAec,MAAf,GAAwB,UAASN,MAAT,EAAgBO,QAAhB,EAAyB;;AAE7C,MAAG,CAACP,MAAJ,EAAW;AACP,WAAOO,QAAQ,CAAC,IAAIlB,MAAM,CAACmB,mBAAX,CAA+B,wBAA/B,CAAD,CAAf;AACH;;AAED,MAAG,CAAClB,KAAK,CAACU,MAAD,CAAT,EAAkB;AACdO,IAAAA,QAAQ,CAAC,IAAD,EAAM,KAAN,CAAR;AACH,GAFD,MAEK;AACD,WAAOA,QAAQ,CAAC,IAAD,EAAM,IAAN,CAAf;AACH;;AAEJ,CAZD;;AAcA;AACA;AACA;AACA;AACA;AACA;AACAhB,MAAM,CAACC,OAAP,CAAeiB,UAAf,GAA4B,UAAST,MAAT,EAAgBI,MAAhB,EAAuBG,QAAvB,EAAgC;;AAExD;;AAEA;AACA;;AAEA;;AAEA;AACA;;AAEA;;AAEA;AACA;;AAEA,MAAG,CAACP,MAAJ,EAAW;;AAEP,WAAOO,QAAQ,CAAC,IAAIlB,MAAM,CAACmB,mBAAX,CAA+B,yBAA/B,CAAD,CAAf;AACH;;AAED,MAAGf,IAAI,CAACY,KAAL,CAAWD,MAAX,CAAH,EAAsB;;AAElBX,IAAAA,IAAI,CAACY,KAAL,CAAWD,MAAX,EAAmBM,MAAnB,GAA4BjB,IAAI,CAACkB,WAAL,CAAiBC,MAA7C;AACAnB,IAAAA,IAAI,CAACY,KAAL,CAAWD,MAAX,EAAmBJ,MAAnB,GAA4BA,MAA5B;;AAEA,QAAIK,KAAK,GAAE,EAAX;;AAEAA,IAAAA,KAAK,CAACD,MAAD,CAAL,GAAeX,IAAI,CAACY,KAAL,CAAWD,MAAX,CAAf;;AAEAd,IAAAA,KAAK,CAACU,MAAD,CAAL,GAAgB;AACZA,MAAAA,MAAM,EAACA,MADK;AAEZK,MAAAA,KAAK,EAACA,KAFM,EAAhB;;;AAKH,GAdD,MAcK;AACD,WAAOE,QAAQ,CAAC,IAAIlB,MAAM,CAACwB,gBAAX,CAA4BT,MAAM,GAAC,+CAAnC,CAAD,CAAf;AACH;;AAED,MAAIU,IAAI,GAAGxB,KAAK,CAACU,MAAD,CAAhB;;AAEA,SAAOO,QAAQ,CAAC,IAAD,EAAMO,IAAN,CAAf;;AAEH,CA5CD;AA6CA;AACA;AACA;AACA;AACA;AACC,SAASC,UAAT,CAAoBf,MAApB,EAA2BO,QAA3B,EAAoC;;AAEjC,MAAG,CAACP,MAAJ,EAAW;;AAEP,WAAOO,QAAQ,CAAC,IAAIlB,MAAM,CAACmB,mBAAX,CAA+B,wBAA/B,CAAD,CAAf;AACH;;AAED,SAAOlB,KAAK,CAACU,MAAD,CAAZ;;AAEA,SAAOO,QAAQ,CAAC,IAAD,CAAf;AACH;AACD;AACA;AACA;AACA;AACA;AACA;;AAEAhB,MAAM,CAACC,OAAP,CAAewB,SAAf,GAA0B,UAAShB,MAAT,EAAgBI,MAAhB,EAAwBG,QAAxB,EAAiC;;AAEvD,MAAG,CAACP,MAAJ,EAAW;AACP,WAAOO,QAAQ,CAAC,IAAIlB,MAAM,CAACmB,mBAAX,CAA+B,2BAA/B,CAAD,CAAf;AACH;;AAED,MAAG,CAACJ,MAAJ,EAAW;AACP,WAAOG,QAAQ,CAAC,IAAIlB,MAAM,CAACmB,mBAAX,CAA+B,yBAA/B,CAAD,CAAf;AACH;;AAED,MAAG,CAAClB,KAAK,CAACU,MAAD,CAAT,EAAkB;AACd,WAAOO,QAAQ,CAAC,IAAIlB,MAAM,CAACmB,mBAAX,CAA+B,qCAAmCR,MAAlE,CAAD,CAAf,CADc,CAC8E;AAC/F;;AAED,MAAG,CAACV,KAAK,CAACU,MAAD,CAAL,CAAcK,KAAd,CAAoBD,MAApB,CAAJ,EAAgC;;AAE5BX,IAAAA,IAAI,CAACY,KAAL,CAAWD,MAAX,EAAmBM,MAAnB,GAA4BjB,IAAI,CAACkB,WAAL,CAAiBC,MAA7C;AACAnB,IAAAA,IAAI,CAACY,KAAL,CAAWD,MAAX,EAAmBJ,MAAnB,GAA4BA,MAA5B;;AAEAV,IAAAA,KAAK,CAACU,MAAD,CAAL,CAAcK,KAAd,CAAoBD,MAApB,IAA6BX,IAAI,CAACY,KAAL,CAAWD,MAAX,CAA7B;;AAEA,WAAOG,QAAQ,CAAC,IAAD,EAAMjB,KAAK,CAACU,MAAD,CAAX,CAAf;;AAEH,GATD,MASK;;AAED,WAAOO,QAAQ;AACX,QAAIlB,MAAM,CAACmB,mBAAX;AACI;AACC,cADD,GACaJ,MADb,GACsB,IADtB;AAEC,cAFD,GAEaJ,MAHjB,CADW,CAAf;;;AAOH;;AAEJ,CAlCD;;AAoCA;AACA;AACA;AACA;AACA;AACA;AACAT,MAAM,CAACC,OAAP,CAAeyB,SAAf,GAA2B,UAASb,MAAT,EAAgBJ,MAAhB,EAAuBO,QAAvB,EAAgC;;AAEvD,MAAG,CAACP,MAAJ,EAAW;AACP,WAAOO,QAAQ,CAAC,IAAIlB,MAAM,CAACmB,mBAAX,CAA+B,2BAA/B,CAAD,CAAf;AACH;;AAED,MAAG,CAACJ,MAAJ,EAAW;AACP,WAAOG,QAAQ,CAAC,IAAIlB,MAAM,CAACmB,mBAAX,CAA+B,wBAA/B,CAAD,CAAf;AACH;;AAED,MAAIlB,KAAK,CAACU,MAAD,CAAL,CAAcK,KAAd,CAAoBD,MAApB,CAAJ,EAAiC;;AAE7Bd,IAAAA,KAAK,CAACU,MAAD,CAAL,CAAcK,KAAd,CAAoBD,MAApB,EAA4BM,MAA5B,GAAqCjB,IAAI,CAACkB,WAAL,CAAiBO,MAAtD;AACA5B,IAAAA,KAAK,CAACU,MAAD,CAAL,CAAcK,KAAd,CAAoBD,MAApB,EAA4BJ,MAA5B,GAAqC,IAArC;AACA,WAAOV,KAAK,CAACU,MAAD,CAAL,CAAcK,KAAd,CAAoBD,MAApB,CAAP;;AAEA,QAAGe,MAAM,CAACC,IAAP,CAAY9B,KAAK,CAACU,MAAD,CAAL,CAAcK,KAA1B,EAAiCJ,MAAjC,IAAyC,CAA5C,EAA8C;AAC1Cc,MAAAA,UAAU,CAACf,MAAD,EAAQ,UAACqB,GAAD,EAAO;;AAErB,YAAGA,GAAH,EAAO;AACH,iBAAOd,QAAQ,CAACc,GAAD,CAAf;AACH;AACJ,OALS,CAAV;AAMH;;AAEJ;;AAED,SAAOd,QAAQ,CAAC,IAAD,CAAf;;;AAGH,CA9BD;;AAgCA;AACA;AACA;AACA;AACA;AACAhB,MAAM,CAACC,OAAP,CAAe8B,SAAf,GAA2B,UAAStB,MAAT,EAAgBO,QAAhB,EAAyB;;AAEhD,MAAG,CAACP,MAAJ,EAAW;AACP,WAAOO,QAAQ,CAAC,IAAIlB,MAAM,CAACmB,mBAAX,CAA+B,yBAA/B,CAAD,CAAf;AACH;;AAED,MAAGR,MAAM,CAACC,MAAP,IAAiBhB,uBAApB,EAA4C;AACxC,WAAOsB,QAAQ,CAAC,IAAD,EAAM,IAAN,CAAf;AACH,GAFD,MAEK;AACD,WAAOA,QAAQ,CAAC,IAAD,EAAM,KAAN,CAAf;AACH;;AAEJ,CAZD;;;AAeA;AACA;AACA;AACA;AACA;AACA;AACA;AACAhB,MAAM,CAACC,OAAP,CAAe+B,SAAf,GAA2B,UAASC,WAAT,EAAqBxB,MAArB,EAA4ByB,OAA5B,EAAoClB,QAApC,EAA6C;;AAEpE,MAAG,CAACiB,WAAJ,EAAgB;AACZ,WAAOjB,QAAQ,CAAC,IAAIlB,MAAM,CAACmB,mBAAX,CAA+B,wBAA/B,CAAD,CAAf;AACH;;AAED,MAAG,CAACR,MAAJ,EAAW;AACP,WAAOO,QAAQ,CAAC,IAAIlB,MAAM,CAACmB,mBAAX,CAA+B,wBAA/B,CAAD,CAAf;AACH;;AAED,MAAG,CAAClB,KAAK,CAACU,MAAD,CAAT,EAAkB;AACd,WAAOO,QAAQ,CAAC,IAAIlB,MAAM,CAACmB,mBAAX,CAA+B,uBAA/B,CAAD,CAAf;AACH;;AAED,OAAI,IAAIJ,MAAR,IAAkBd,KAAK,CAACU,MAAD,CAAL,CAAcK,KAAhC,EAAsC;AAClC,QAAGD,MAAM,IAAIoB,WAAb,EAAyB;AACrB/B,MAAAA,IAAI,CAACiC,MAAL,CAAYtB,MAAZ,EAAmBqB,OAAnB,EAA2BlB,QAA3B;AACH;AACJ;;AAED,SAAOA,QAAQ,CAAC,IAAD,CAAf;;AAEH,CAtBD","sourcesContent":["\r\nvar ROOM_AVAILABLE_USER_NUM = require('./constants').ROOM_AVAILABLE_USER_NUM;\r\nvar MAX_ROOM_NAME_LENGTH =require('./constants').MAX_ROOM_NAME_LENGTH;\r\nvar MIN_ROOM_NAME_LENGTH = require('./constants').MIN_ROOM_NAME_LENGTH;\r\nvar errors = require('./errors')\r\nvar rooms ={}\r\n\r\nmodule.exports.rooms = rooms;\r\n\r\nvar user= require('./user.js');\r\n\r\nvar forbiddenNames = [\r\n    \r\n];\r\n\r\n/**\r\n * \r\n * @param {*} roomName \r\n */\r\nfunction isNameForbidden(roomName){\r\n\r\n    return forbiddenNames.indexOf(roomIDs) >=0;\r\n}\r\n\r\nfunction isNameTooLong(roomID){\r\n\r\n    return roomID.length > MAX_ROOM_NAME_LENGTH; \r\n}\r\n\r\nfunction isNameTooShort(roomID){\r\n\r\n    return roomID.length < MIN_ROOM_NAME_LENGTH;\r\n}\r\n\r\nfunction isUserinRoom(userID,roomID){\r\n\r\n    if (rooms[roomID].users[userID]){\r\n        \r\n        return true;\r\n    }else{\r\n        return false;\r\n    }\r\n\r\n}\r\n\r\n\r\n\r\n/**\r\n * Room이 존재하는지 확인\r\n * @param {string} roomID \r\n * @param {function} callback \r\n */\r\nmodule.exports.isRoom = function(roomID,callback){\r\n    \r\n    if(!roomID){\r\n        return callback(new errors.InvalidMessageError('roomID cat not be null'))\r\n    }\r\n\r\n    if(!rooms[roomID]){\r\n        callback(null,false)\r\n    }else{\r\n        return callback(null,true)\r\n    }\r\n\r\n}\r\n\r\n/**\r\n * \r\n * @param {String} roomID \r\n * @param {String} userID \r\n * @param {function} callback \r\n */\r\nmodule.exports.createRoom = function(roomID,userID,callback){\r\n\r\n    // if(!isNameForbidden(roomID)){\r\n\r\n    //     return callback(new Error('roomID is forbiddenNames'));     \r\n    // }\r\n\r\n    // if(!isNameTooLong(roomID)){\r\n\r\n    //     return callback(new Error('roomID is too Long'));\r\n    // }\r\n\r\n    // if(!isNameTooShort(roomID)){\r\n\r\n    //     return callback(new Error('roomID is too Short'))\r\n    // }\r\n\r\n    if(!roomID){\r\n\r\n        return callback(new errors.InvalidMessageError('roomeID can not be null'));\r\n    }\r\n\r\n    if(user.users[userID]){\r\n\r\n        user.users[userID].status = user.USER_STATUS.INROOM;\r\n        user.users[userID].roomID = roomID;\r\n        \r\n        var users ={};\r\n\r\n        users[userID]= user.users[userID]; \r\n\r\n        rooms[roomID] = {\r\n            roomID:roomID,\r\n            users:users\r\n        };\r\n\r\n    }else{\r\n        return callback(new errors.InvalidUserError(userID+' dont have connection you have to login first'))\r\n    }\r\n\r\n    var room = rooms[roomID]\r\n\r\n    return callback(null,room)\r\n\r\n}\r\n/**\r\n * \r\n * @param {String} roomID \r\n * @param {function} callback \r\n */\r\n function deleteRoom(roomID,callback){\r\n\r\n    if(!roomID){\r\n\r\n        return callback(new errors.InvalidMessageError('roomID can not be null'));\r\n    }\r\n\r\n    delete rooms[roomID]\r\n    \r\n    return callback(null)\r\n}\r\n/**\r\n * \r\n * @param {String} roomID \r\n * @param {String} userID \r\n * @param {function} callback \r\n */\r\n\r\nmodule.exports.enterRoom =function(roomID,userID, callback){\r\n\r\n    if(!roomID){\r\n        return callback(new errors.InvalidMessageError('roomename can not be null'));\r\n    }\r\n\r\n    if(!userID){\r\n        return callback(new errors.InvalidMessageError('userID cant not be null'));\r\n    }\r\n\r\n    if(!rooms[roomID]){\r\n        return callback(new errors.InvalidMessageError('room is not avaliavle \\n roomID:'+roomID))  //it will never happen\r\n    }\r\n\r\n    if(!rooms[roomID].users[userID]){\r\n\r\n        user.users[userID].status = user.USER_STATUS.INROOM;\r\n        user.users[userID].roomID = roomID;\r\n        \r\n        rooms[roomID].users[userID] =user.users[userID];\r\n\r\n        return callback(null,rooms[roomID])\r\n    \r\n    }else{\r\n        \r\n        return callback(\r\n            new errors.InvalidMessageError(\r\n                'user is alredy in the room \\n' \r\n                +'userID: '+ userID + '\\n'\r\n                +'roomID: '+ roomID\r\n            )\r\n        );\r\n    }\r\n\r\n}\r\n\r\n/**\r\n * \r\n * @param {String} userID \r\n * @param {String} roomID \r\n * @param {function} callback \r\n */\r\nmodule.exports.leaveRoom = function(userID,roomID,callback){\r\n\r\n    if(!roomID){\r\n        return callback(new errors.InvalidMessageError('roomename can not be null'));\r\n    }\r\n\r\n    if(!userID){\r\n        return callback(new errors.InvalidMessageError('userID can not be null'));\r\n    }\r\n\r\n    if( rooms[roomID].users[userID] ){\r\n\r\n        rooms[roomID].users[userID].status = user.USER_STATUS.ONLINE;\r\n        rooms[roomID].users[userID].roomID = null;\r\n        delete rooms[roomID].users[userID];\r\n        \r\n        if(Object.keys(rooms[roomID].users).length<=0){\r\n            deleteRoom(roomID,(err)=>{\r\n\r\n                if(err){\r\n                    return callback(err);\r\n                }\r\n            });\r\n        }\r\n    \r\n    }\r\n\r\n    return callback(null);\r\n    \r\n\r\n}\r\n\r\n/**\r\n * \r\n * @param {String} roomID \r\n * @param {callback} callback \r\n */\r\nmodule.exports.checkfull = function(roomID,callback){\r\n\r\n    if(!roomID){\r\n        return callback(new errors.InvalidMessageError('roomeID can not be null'));\r\n    }\r\n\r\n    if(roomID.length <= ROOM_AVAILABLE_USER_NUM){\r\n        return callback(null,true);\r\n    }else{\r\n        return callback(null,false);\r\n    }\r\n\r\n}\r\n\r\n\r\n/**\r\n * 룸에 있는 모든 인원에게 메시지 보내는 function\r\n * @param {String} from_userID \r\n * @param {String} roomID \r\n * @param {String} message   \r\n * @param {function} callback \r\n */\r\nmodule.exports.broadcast = function(from_userID,roomID,message,callback){\r\n\r\n    if(!from_userID){\r\n        return callback(new errors.InvalidMessageError('userID can not be null'));\r\n    }\r\n\r\n    if(!roomID){\r\n        return callback(new errors.InvalidMessageError('roomID can not be null'));\r\n    }\r\n\r\n    if(!rooms[roomID]){\r\n        return callback(new errors.InvalidMessageError('room is not available'));\r\n    }\r\n\r\n    for(var userID in rooms[roomID].users){\r\n        if(userID != from_userID){\r\n            user.sendTo(userID,message,callback)\r\n        }\r\n    }\r\n\r\n    return callback(null)\r\n    \r\n}\r\n\r\n\r\n\r\n\r\n"],"file":"room.js"}